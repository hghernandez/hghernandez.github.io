---
title: "Retencion de clientes: Analisis por cohortes"
description: |
  En la estrategia comercial de cualquier emprendimiento uno de los KPI¬¥s que se vuelve imprescindible monitorear es cu√°ntos clientes nos siguen comprando en un per√≠odo de tiempo dado o cuantos clientes nos han abandonado. En este post voy a mostrar como calcular este indicador mediante el an√°lisis de cohortes.
preview: imagenes/retencion.jpg
author:
  - name: Hernan Hernandez
    url: https://example.com/norajones
date: 2022-09-05
output:
  distill::distill_article:
    self_contained: false
    toc: true
    toc_depth: 2
    toc_float: true
    code_folding: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "##",
  R.options = list(width = 60)
)
```

# Introducci√≥n üöÄ

Bienvenidos y bienvenidas a un nuevo **post** sobre un **KPI** (Key Performance Indicator) muy importante al momento de analizar la **estrategia comercial** de cualquier empresa o negocio y que responde a una cuesti√≥n central: ¬øque proporci√≥n de los clientes que nos compraron en alg√∫n momento lo siguen haciendo en determinado per√≠odo? y en este misma l√≠nea: ¬øque proporci√≥n dej√≥ de hacerlo?.

De lo anterior se desprenden tres conceptos importantes:

-   **Tasa de retenci√≥n**: representa la proporci√≥n de clientes que nos siguen comprando en determinado per√≠odo de tiempo.

-   **Churn de clientes o tasa de abandono**: es la proporci√≥n de clientes que han abandonado nuestro negocio.

-   **An√°lisis de cohortes**: representa un m√©todo de an√°lisis de la retenci√≥n o abandono en el cu√°l hacemos un seguimiento de los clientes a lo largo de un tiempo (seguimiento longitudinal). A su vez, una **cohorte** est√° caracterizada por un criterio com√∫n que los agrupa, como puede ser por ejemplo la fecha de su primer compra en nuestro negocio.

    Si nos resultan confusos estos conceptos üò±, veamos un ejemplo y revisemos la construcci√≥n de c√≥digo.

    # Cargamos el dataset y activamos los paquetes üìö

Para este ejemplo utilizaremos el mismo dataset que trabajamos en el art√≠culo de [**An√°lisis RFM**](https://hghernandez.github.io/posts/2022-08-27-analisis-rfm-para-la-segmentacion-de-clientes/ "An√°lisis RFM") **,** el cual lo hab√≠amos obtenido de [Kaggle](https://www.kaggle.com/datasets/carrie1/ecommerce-data?resource=download "Kaggle"). Recordemos que se trataba de las ventas e-commerce de una tienda minorista con sede en el Reino Unido y operaciones en varios pa√≠ses.

```{r }
##Cargo el dataset y las funciones

df <- read.csv("data/data.csv")

#Cargo las librerias

library(dplyr)
library(lubridate)
library(tidyr)
library(ggplot2)
library(plotly)

```

Veamos üßê las variables del dataset [^1]:

[^1]: Puede encontrar una exploraci√≥n completa del dataset en el **An√°lisis RFM e**n el siguiente [**link**](https://hghernandez.github.io/posts/2022-08-27-analisis-rfm-para-la-segmentacion-de-clientes/ "link a articulo")**.**

```{r}
glimpse(df)
```

De todas las variables de dataset, utilizaremos para nuestro an√°lisis la **fecha de factura** (InvoiceData), la **identificaci√≥n del usuario** (CustomerID) y el **pa√≠s** (Country).

# Comenzamos el procesamiento üé¨

En esta etapa realizaremos dos transformaciones centrales en el an√°lisis de la retenci√≥n por cohortes:

-   **Creamos las cohortes**: el criterio para agrupar los usuarios y crear los cohortes es el mes en la cual realizaron la primer compra a nuestro negocio.

-   **Creamos los meses de permanencia: s**on los meses en los cuales los usuarios registran compras a nuestro negocio.

    Adem√°s vamos a excluir los usuarios sin identificaci√≥n y adem√°s vamos a convertir la variable de fecha de facturaci√≥n que es de cadena en una variable de fecha.

    ```{r}

    df <- df %>%
      mutate(Date= as_date(lubridate::mdy_hm(InvoiceDate))) %>%
      filter(!is.na(CustomerID))%>% #Excluimos usuarios sin identificaci√≥n
      group_by(CustomerID)%>%
      mutate(min_fecha= min(Date), 
             cohorte = paste0(month(min_fecha),"-",year(min_fecha)), #Creamos la cohorte seg√∫n la fecha de la m√≠nima compra
             mes= interval(min(Date),Date) %/% months(1)) #Representa los meses en que el usuario ha realizado compras
    ```

    # Obtenemos la tasa de retenci√≥n üß≤

    En este punto del an√°lisis vamos a obtener la **tasa de retenci√≥n.** Para ello, contaremos los usuarios (distintos) por **cohorte** y por **mes de compra.** Luego, calculamos la tasa de retenci√≥n como el cociente entre la cantidad de usuarios en determinado mes por la cantidad de usuarios en el mes inicial de seguimiento de la cohorte. Por √∫ltimo, mostramos la evoluci√≥n de la tasa en un heatmap.

    ```{r fig.cap= "Tasa de retenci√≥n 12 meses", layout= "l-page"}
    rate.retention <- df %>%
      group_by(cohorte,mes)%>%
      summarise(n = n_distinct(CustomerID))%>%
      mutate(rate= round(n*100/n[mes==0],1),
             cohorte= format(lubridate::my(cohorte),"%b-%Y")) %>%
      arrange(cohorte) %>%
      as.data.frame() %>%
      ggplot(aes(x= mes, y= reorder(cohorte,mes), fill= rate))+
      geom_tile()+
      geom_text(aes(label = rate), color = "white", size = 3) +
      scale_fill_gradient2(low = "#E0F3DB",mid="#A8DDB5",high = "#43A2CA") +
      scale_x_continuous(breaks = seq(0,12),expand = c(0,0))+
      labs(y= "Cohorte", x= "Mes", fill= "Tasa")+
      coord_fixed()+
      theme_minimal()

    rate.retention
    ```

## Algunas observaciones üì£

-   El an√°lisis por cohortes nos permite hacer seguimiento de los usuarios pudiendo encontrar patrones de comportamiento distintos seg√∫n el mes en el cu√°l realizaron la primer compra a nuestro negocio. De esta forma podemos evaluar como impacta una campa√±a o una promoci√≥n que lanzamos en determinado momento sobre la fidelizaci√≥n de nuestros clientes.

-   Asimismo, podr√≠amos monetizar el comportamiento de las cohorte obteniendo el promedio gastado por determinada cohorte a lo largo del tiempo de seguimiento (Ver Figura \@ref(fig:fp)).

-   En el an√°lisis vertical (por columnas) podemos evaluar el comportamiento de las cohortes por mes. Por ejemplo: podemos decir que excluyendo noviembre y diciembre de 2011, entre el 17 y el 38% de los clientes que realizan una compra en determinado mes, vuelven a tener una al mes siguiente.

-   En el an√°lisis horizontal (por filas), excluyendo diciembre de 2011 que no est√° completo (la fecha m√°xima es 9 de diciembre), casi un 50% de los usuarios a√∫n siguen realizando compras al a√±o. De hecho, la cohorte de dic-2010 muestra una mejora en la retenci√≥n al mes 10 y 12, lo que ameritar√≠a investigar si se implement√≥ alguna campa√±a o promoci√≥n.

    ```{r fp,fig.cap= "Promedio gastado por las cohorte", layout= "l-page"}

    monetize <- df %>%
      group_by(cohorte,mes)%>%
      summarise(prom= round(mean(UnitPrice),1))%>%
      mutate(cohorte= format(lubridate::my(cohorte),"%b-%Y")) %>%
      arrange(cohorte) %>%
      as.data.frame() %>%
    ggplot(aes(x= mes, y= reorder(cohorte,mes), fill= prom))+
      geom_tile()+
      geom_text(aes(label = prom), color = "white", size = 3) +
      scale_fill_gradient2(low = "#E0F3DB",mid="#A8DDB5",high = "#43A2CA") +
      scale_x_continuous(breaks = seq(0,12),expand = c(0,0))+
      labs(y= "Cohorte", x= "Mes", fill= "Tasa")+
      coord_fixed()+
      theme_minimal()

    monetize
    ```

## Podemos explorar a nivel de pa√≠ses üó∫Ô∏è

Como hab√≠amos dicho el dataset tiene los datos de ventas en UK y en varios pa√≠ses asi que podemos explorar este aspecto.

Para eso seleccionaremos los principales 3 pa√≠ses seg√∫n la cantidad de clientes, que son: Reino Unido, Francia y Alemania.

Manos a la obra ‚ùó

```{r}
paises <- c("United Kingdom","France","Germany")

rate.retention.country <- list()

for(pais in paises){
 
rate.retention.country[[pais]]<-
  df %>%
  filter(Country== pais)%>%
  group_by(cohorte,mes)%>%
  summarise(n = n_distinct(CustomerID))%>%
  mutate(rate= round(n*100/n[mes==0],1),
         cohorte= format(lubridate::my(cohorte),"%b-%Y")) %>%
  arrange(cohorte) %>%
  as.data.frame() %>%
  ggplot(aes(x= mes, y= reorder(cohorte,mes), fill= rate))+
  geom_tile()+
  geom_text(aes(label = rate), color = "white", size = 3) +
  scale_fill_gradient2(low = "#E0F3DB",mid="#A8DDB5",high = "#43A2CA") +
  scale_x_continuous(breaks = seq(0,12))+
  labs(y= "Cohorte", x= "Mes", fill= "Tasa")+
  coord_fixed()
  
  
}
```

```{r xaringan-panelset, echo=FALSE}
xaringanExtra::use_panelset()
```

::: panelset
```{r results='asis'}
for(i in 1:length(rate.retention.country)){
  cat("::: {.panel}\n")             
  cat("##",paises[i], "{.panel-name}\n")
  print(rate.retention.country[[i]])
  cat("\n") 
  cat(":::\n")
}

```
:::

C√≥mo puede verse en los gr√°ficos, a nivel pa√≠s se obtienen tasas de retenci√≥n que resultan inestables por lo que los datos deben ser tomados con cautela. Lo que si resulta claro es que el comportamiento de la tasa de retenci√≥n en general responde casi exclusivamente al comportamiento de los clientes de UK.

# Comentarios finales üòè

üëÄ El an√°lisis de la tasa de retenci√≥n mediante cohortes representan un aliado a la hora de evaluar la estrategia comercial a la luz del comportamiento de nuestros clientes y c√≥mo estos responden a las diferentes acciones como las campa√±as, las promociones, el lanzamiento de nuevos productos, etc.

‚öìTambi√©n este tipo de an√°lisis podemos profundizarlos con otros para estimar el Customer Lifetime Value (CLV) y conocer cuanto puede ganar la empresa del cliente promedio en el transcurso de la relaci√≥n, pero eso ser√° parte de otro post üí™üèº.
